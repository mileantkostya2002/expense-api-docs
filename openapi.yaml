openapi: 3.0.0
info:
  title: Odoo Expense API
  version: 1.0.0
  description: API for managing employee expenses, expense reports, attachments, and related resources in Odoo.

servers:
  - url: https://your-odoo-domain.com
    description: Production server

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: Employee API token from hr.employee.api_token field

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: "Error message description"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Error message description"

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "All expenses must belong to you"
        invalid_expense_ids:
          type: array
          items:
            type: integer
          example: [105, 106]

    StateErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Report can only be edited in \"draft\" state"
        current_state:
          type: string
          example: "approve"

    Expense:
      type: object
      properties:
        id:
          type: integer
          example: 123
        name:
          type: string
          example: "Hotel accommodation"
        description:
          type: string
          example: "Business trip hotel stay"
        total_amount_currency:
          type: number
          example: 150.00
        currency:
          type: string
          example: "EUR"
        date:
          type: string
          format: date
          example: "2025-10-05"
        state:
          type: string
          enum: [draft, reported, approved, done, refused]
          example: "draft"
        state_display:
          type: string
          example: "To Submit"
        payment_mode:
          type: string
          enum: [own_account, company_account]
          example: "own_account"
        payment_mode_display:
          type: string
          example: "Employee (to reimburse)"
        company:
          type: object
          properties:
            id:
              type: integer
              example: 1
            name:
              type: string
              example: "My Company"
        product:
          type: object
          properties:
            id:
              type: integer
              example: 5
            name:
              type: string
              example: "Accommodation"
        vendor:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              example: 10
            name:
              type: string
              example: "Hotel Chain Inc"
        vehicle:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              example: 3
            name:
              type: string
              example: "Company Car ABC-123"
        task:
          type: object
          nullable: true
          properties:
            id:
              type: integer
              example: 25
            name:
              type: string
              example: "Project Alpha - Phase 1"
            partner_id:
              type: integer
              nullable: true
              example: 42
        taxes:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 1
              name:
                type: string
                example: "VAT 20%"
              amount:
                type: number
                example: 20.0
        attachments:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 301
              name:
                type: string
                example: "receipt_hotel.pdf"
              mimetype:
                type: string
                example: "application/pdf"
              file_size:
                type: integer
                example: 245678
        attachment_count:
          type: integer
          example: 2
        receipt_image:
          type: integer
          nullable: true
          example: 301
        create_date:
          type: string
          example: "2025-10-05T10:30:00"
        write_date:
          type: string
          example: "2025-10-15T14:20:00"

    ExpenseReport:
      type: object
      properties:
        id:
          type: integer
          example: 42
        name:
          type: string
          example: "Business Trip - October 2025"
        employee:
          type: object
          properties:
            id:
              type: integer
              example: 15
            name:
              type: string
              example: "John Doe"
        company:
          type: object
          properties:
            id:
              type: integer
              example: 1
            name:
              type: string
              example: "My Company"
        state:
          type: string
          example: "draft"
        state_display:
          type: string
          example: "Draft"
        total_amount:
          type: number
          example: 450.75
        currency_id:
          type: integer
          example: 1
        currency_name:
          type: string
          example: "EUR"
        expense_count:
          type: integer
          example: 3
        expenses:
          type: array
          items:
            $ref: '#/components/schemas/Expense'
        create_date:
          type: string
          example: "2025-10-01T09:00:00"
        write_date:
          type: string
          example: "2025-10-15T16:45:00"
        approval_date:
          type: string
          nullable: true
          example: null

    UpdateReportRequest:
      type: object
      required:
        - expense_ids
      properties:
        expense_ids:
          type: array
          items:
            type: integer
          description: |
            List of expense IDs to include in the report.
            **IMPORTANT:** Pass an empty array [] to delete the report.
          example: [101, 102, 103]
        name:
          type: string
          description: Optional new name for the report
          example: "Updated Business Trip - October 2025"
        journal_id:
          type: integer
          description: Optional journal ID
          example: 5

    UpdateReportSuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        report_id:
          type: integer
          example: 42
        report_name:
          type: string
          example: "Business Trip - October 2025"
        employee_id:
          type: integer
          example: 15
        employee_name:
          type: string
          example: "John Doe"
        company_id:
          type: integer
          example: 1
        company_name:
          type: string
          example: "My Company"
        total_amount:
          type: number
          format: float
          example: 450.75
        expense_count:
          type: integer
          example: 3
        state:
          type: string
          example: "draft"
        expenses_updated:
          type: array
          items:
            type: object
            properties:
              id:
                type: integer
                example: 101
              state:
                type: string
                example: "reported"
        message:
          type: string
          example: "Expense report updated successfully"

    DeleteReportResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        report_deleted:
          type: boolean
          example: true
        report_id:
          type: integer
          example: 42
        report_name:
          type: string
          example: "Business Trip - October 2025"
        message:
          type: string
          example: "Expense report deleted because no expenses remained"

paths:
  /api/v1/expenses:
    get:
      summary: Get employee expenses list
      description: Returns a list of expenses for the authenticated employee. By default shows current month expenses. Supports filtering, sorting, and pagination.
      tags:
        - Expenses
      security:
        - bearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
          description: Number of records to return
          example: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Offset for pagination
          example: 0
        - name: state
          in: query
          schema:
            type: string
            enum: [draft, reported, approved, done, refused]
          description: Filter by expense state
          example: "draft"
        - name: date_from
          in: query
          schema:
            type: string
            format: date
          description: Filter from date (YYYY-MM-DD)
          example: "2025-10-01"
        - name: date_to
          in: query
          schema:
            type: string
            format: date
          description: Filter to date (YYYY-MM-DD)
          example: "2025-10-31"
        - name: q
          in: query
          schema:
            type: string
          description: Search by name or description
          example: "hotel"
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [date, name, amount, create_date]
            default: date
          description: Sort field
          example: "date"
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          description: Sort order
          example: "desc"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Expense'
                  pagination:
                    type: object
                    properties:
                      total_count:
                        type: integer
                        example: 45
                      limit:
                        type: integer
                        example: 20
                      offset:
                        type: integer
                        example: 0
                      has_next:
                        type: boolean
                        example: true
                      has_prev:
                        type: boolean
                        example: false
                  filters:
                    type: object
                  employee:
                    type: object
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/expense:
    post:
      summary: Create new expense
      description: Creates a new expense for the authenticated employee
      tags:
        - Expenses
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - total_amount_currency
                - product_id
              properties:
                name:
                  type: string
                  description: Expense description
                  example: "Hotel accommodation"
                total_amount_currency:
                  type: number
                  description: Expense amount
                  example: 150.00
                product_id:
                  type: integer
                  description: Product category ID
                  example: 5
                payment_mode:
                  type: string
                  enum: [own_account, company_account]
                  default: own_account
                  example: "own_account"
                vendor_id:
                  type: integer
                  description: Vendor ID (required for company_account payment mode)
                  example: 10
                date:
                  type: string
                  format: date
                  example: "2025-10-05"
                description:
                  type: string
                  example: "Business trip hotel stay"
                tax_ids:
                  type: array
                  items:
                    type: integer
                  example: [1]
                task:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 25
                vehicle:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 3
      responses:
        '201':
          description: Expense created successfully
        '400':
          description: Bad request
        '401':
          description: Unauthorized

  /api/v1/expense/{expense_id}:
    get:
      summary: Get single expense details
      tags:
        - Expenses
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Expense'
        '404':
          description: Expense not found

    put:
      summary: Update expense
      description: Updates expense (only in draft or reported state)
      tags:
        - Expenses
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  example: "Updated hotel accommodation"
                total_amount_currency:
                  type: number
                  example: 175.00
                product_id:
                  type: integer
                  example: 5
                payment_mode:
                  type: string
                  example: "own_account"
                vendor_id:
                  type: integer
                  example: 10
                date:
                  type: string
                  format: date
                  example: "2025-10-06"
                description:
                  type: string
                  example: "Extended business trip"
                tax_ids:
                  type: array
                  items:
                    type: integer
                  example: [1]
                task:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 25
                vehicle:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 3
      responses:
        '200':
          description: Expense updated successfully
        '403':
          description: Cannot edit expense in current state
        '404':
          description: Expense not found

  /api/v1/expense/{expense_id}/delete:
    delete:
      summary: Delete expense
      description: Deletes expense (only in draft or reported state)
      tags:
        - Expenses
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      responses:
        '200':
          description: Expense deleted successfully
        '403':
          description: Cannot delete expense in current state
        '404':
          description: Expense not found

  /api/v1/expense/reports:
    get:
      summary: Get expense reports list
      description: Returns a list of expense reports for the authenticated employee
      tags:
        - Expense Reports
      security:
        - bearerAuth: []
      parameters:
        - name: state
          in: query
          schema:
            type: string
          description: Filter by report state
          example: "draft"
        - name: q
          in: query
          schema:
            type: string
          description: Search by report name
          example: "Business Trip"
        - name: date_from
          in: query
          schema:
            type: string
            format: date
          example: "2025-10-01"
        - name: date_to
          in: query
          schema:
            type: string
            format: date
          example: "2025-10-31"
        - name: sort_by
          in: query
          schema:
            type: string
            default: create_date
          example: "create_date"
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
          example: "desc"
      responses:
        '200':
          description: Successful response

  /api/v1/report/{report_id}:
    get:
      summary: Get single expense report details
      tags:
        - Expense Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: integer
          example: 42
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/ExpenseReport'
        '404':
          description: Report not found

    put:
      summary: Update expense report
      description: |
        Updates an expense report by adding or removing expenses.
        
        **Important Rules:**
        - Only works for reports in **'draft'** state
        - All expenses must belong to the authenticated employee
        - Expenses must be in 'draft' or 'reported' state
        - Expenses cannot be in other active reports
        - **If expense_ids is an empty array [], the report will be automatically deleted**
        
        **Behavior:**
        - Replaces all expenses in the report with the provided list
        - Draft expenses are automatically changed to 'reported' state
        - Empty draft reports are automatically cleaned up
      tags:
        - Expense Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          description: ID of the expense report to update
          schema:
            type: integer
          example: 42
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReportRequest'
            examples:
              update_expenses:
                summary: Update report with new expenses
                value:
                  expense_ids: [101, 102, 103]
                  name: "Updated Business Trip - October 2025"
                  journal_id: 5
              
              remove_one_expense:
                summary: Remove one expense from report
                description: Keep only expenses 101 and 102, remove 103
                value:
                  expense_ids: [101, 102]
              
              delete_report:
                summary: Delete report (empty expense list)
                description: Passing an empty array will delete the entire report
                value:
                  expense_ids: []
      
      responses:
        '200':
          description: |
            Report updated successfully.
            
            **Note:** If expense_ids was empty, the report is deleted and you'll receive a DeleteReportResponse instead.
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/UpdateReportSuccessResponse'
                  - $ref: '#/components/schemas/DeleteReportResponse'
              examples:
                update_success:
                  summary: Report updated successfully
                  value:
                    success: true
                    report_id: 42
                    report_name: "Business Trip - October 2025"
                    employee_id: 15
                    employee_name: "John Doe"
                    company_id: 1
                    company_name: "My Company"
                    total_amount: 450.75
                    expense_count: 3
                    state: "draft"
                    expenses_updated:
                      - id: 101
                        state: "reported"
                      - id: 102
                        state: "reported"
                      - id: 103
                        state: "reported"
                    message: "Expense report updated successfully"
                
                report_deleted:
                  summary: Report deleted (empty expense_ids)
                  value:
                    success: true
                    report_deleted: true
                    report_id: 42
                    report_name: "Business Trip - October 2025"
                    message: "Expense report deleted because no expenses remained"
        
        '400':
          description: Bad request - validation error
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ErrorResponse'
                  - $ref: '#/components/schemas/ValidationErrorResponse'
                  - $ref: '#/components/schemas/StateErrorResponse'
              examples:
                empty_body:
                  summary: Empty request body
                  value:
                    error: "Empty request body. Please provide JSON data"
                
                invalid_json:
                  summary: Invalid JSON format
                  value:
                    error: "Invalid JSON format: Expecting value: line 1 column 1 (char 0)"
                
                missing_expense_ids:
                  summary: Missing expense_ids field
                  value:
                    error: "expense_ids list is required"
                
                wrong_state:
                  summary: Report not in draft state
                  value:
                    error: "Report can only be edited in \"draft\" state"
                    current_state: "approve"
                
                expenses_not_found:
                  summary: Some expenses don't exist
                  value:
                    error: "Some expenses not found"
                
                invalid_expense_state:
                  summary: Expenses in wrong state
                  value:
                    error: "Expenses must be in \"draft\" or \"reported\" state"
                    invalid_expense_ids: [105, 106]
                    invalid_states:
                      - id: 105
                        state: "approved"
                      - id: 106
                        state: "done"
                
                expenses_in_other_reports:
                  summary: Expenses already in other reports
                  value:
                    error: "Some expenses are already included in other reports"
                    expenses_in_reports:
                      - id: 107
                        sheet_id: 50
                        sheet_name: "Another Report"
                      - id: 108
                        sheet_id: 51
                        sheet_name: "Different Report"
        
        '403':
          description: Forbidden - not authorized to edit this report
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/ErrorResponse'
                  - $ref: '#/components/schemas/ValidationErrorResponse'
              examples:
                not_own_report:
                  summary: Report belongs to another employee
                  value:
                    error: "You can only edit your own expense reports"
                
                not_own_expenses:
                  summary: Some expenses belong to another employee
                  value:
                    error: "All expenses must belong to you"
                    invalid_expense_ids: [109, 110]
        
        '404':
          description: Expense report not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Expense report not found"
        
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Internal server error: Database connection failed"

  /api/v1/expense/create-report:
    post:
      summary: Create expense report
      description: Creates an expense report with multiple expenses
      tags:
        - Expense Reports
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - expense_ids
              properties:
                name:
                  type: string
                  description: Report name (auto-generated if not provided)
                  example: "Business Trip - October 2025"
                expense_ids:
                  type: array
                  items:
                    type: integer
                  description: List of expense IDs to include
                  example: [101, 102, 103]
                journal_id:
                  type: integer
                  description: Journal ID (optional)
                  example: 5
      responses:
        '201':
          description: Report created successfully
        '400':
          description: Invalid request

  /api/v1/report/{report_id}/submit:
    post:
      summary: Submit expense report
      description: Submits expense report for approval
      tags:
        - Expense Reports
      security:
        - bearerAuth: []
      parameters:
        - name: report_id
          in: path
          required: true
          schema:
            type: integer
          example: 42
      responses:
        '200':
          description: Report submitted successfully
        '400':
          description: Cannot submit report in current state

  /api/v1/expense/{expense_id}/attachments:
    get:
      summary: Get expense attachments list
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      responses:
        '200':
          description: Successful response

    post:
      summary: Create attachment for expense
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_name
                - file_data
              properties:
                file_name:
                  type: string
                  description: File name with extension
                  example: "receipt_hotel.pdf"
                file_data:
                  type: string
                  description: Base64 encoded file data
                  example: "JVBERi0xLjQKJeLjz9MKMyAwIG9iago8PC9UeXBlL..."
      responses:
        '201':
          description: Attachment created successfully
        '400':
          description: Invalid request
        '403':
          description: Cannot create attachment in current expense state

  /api/v1/expense/file/{expense_id}/attachments/{attachment_id}:
    get:
      summary: Download attachment file
      description: Returns the attachment file as binary data
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
        - name: attachment_id
          in: path
          required: true
          schema:
            type: integer
          example: 301
      responses:
        '200':
          description: File downloaded successfully
          content:
            application/pdf:
              schema:
                type: string
                format: binary
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
        '403':
          description: Access denied
        '404':
          description: Attachment not found

  /api/v1/expense/{expense_id}/attachment/{attachment_id}:
    get:
      summary: Get attachment data
      description: Returns attachment metadata and base64 encoded data
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
        - name: attachment_id
          in: path
          required: true
          schema:
            type: integer
          example: 301
      responses:
        '200':
          description: Successful response

    put:
      summary: Update attachment
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
        - name: attachment_id
          in: path
          required: true
          schema:
            type: integer
          example: 301
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                file_name:
                  type: string
                  example: "updated_receipt.pdf"
                file_data:
                  type: string
                  example: "JVBERi0xLjQKJeLjz9MKMyAwIG9iago8PC9UeXBlL..."
      responses:
        '200':
          description: Attachment updated successfully

    delete:
      summary: Delete attachment
      tags:
        - Attachments
      security:
        - bearerAuth: []
      parameters:
        - name: expense_id
          in: path
          required: true
          schema:
            type: integer
          example: 123
        - name: attachment_id
          in: path
          required: true
          schema:
            type: integer
          example: 301
      responses:
        '200':
          description: Attachment deleted successfully

  /api/v1/expense/categories:
    get:
      summary: Get expense categories
      description: Returns list of products that can be used for expenses (public endpoint)
      tags:
        - Reference Data
      security: []
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  categories:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 5
                        name:
                          type: string
                          example: "Accommodation"
                        default_code:
                          type: string
                          example: "ACC-001"
                        list_price:
                          type: number
                          example: 0.0
                        uom_name:
                          type: string
                          example: "Unit"
                  count:
                    type: integer
                    example: 15

  /api/v1/expense/vendors:
    get:
      summary: Get vendors list
      description: Returns list of vendors for company_account payment mode (public endpoint)
      tags:
        - Reference Data
      security: []
      responses:
        '200':
          description: Successful response

  /api/v1/vehicles:
    get:
      summary: Get vehicles list
      description: Returns list of all available vehicles (public endpoint)
      tags:
        - Reference Data
      security: []
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  count:
                    type: integer
                    example: 5
                  vehicles:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                          example: 3
                        name:
                          type: string
                          example: "Company Car ABC-123"
                        driver:
                          type: string
                          nullable: true
                          example: "John Doe"
                        employee_id:
                          type: integer
                          nullable: true
                          example: 15

tags:
  - name: Expenses
    description: Expense management operations
  - name: Expense Reports
    description: Expense report management
  - name: Attachments
    description: Attachment management for expenses
  - name: Reference Data
    description: Categories, vendors, and vehicles
